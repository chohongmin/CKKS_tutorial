#pragma once

#include "CKKS_ks_wih_dnum.h"
#include "CKKS_lineartransform.h"
#include "CKKS_poly.h"

//
template<int N, int L, int DNUM, int K>
void EvalMod_h_64(  const uint64_t q[L],
					const uint64_t p[K], uint64_t Delta,
					const uint64_t evk_hat[DNUM][2][DNUM*K+K][1<<10],
					const uint64_t         ct_hat[2][L  ][N],
					      uint64_t ct_evalmod_hat[2][L-7][N]){
	double c[]={-4.09661164603151497413e-14, 2.88598082682297751855e-01, 5.14226153064063710341e-13, -3.28427438921730152632e-01, -2.51859617865427594444e-12, 2.38989152129710058503e-01, -3.70547041220033746330e-12, -7.74219332912362223631e-01, -7.31114835623985538791e-12, -1.21135011454625574068e-02, -8.30193203175233300180e-12, -1.10914611315481748122e-01, -7.80283010321730146427e-12, 3.84398312923687257570e-01, -7.14056550677220599433e-12, 5.16594796544579071274e-01, -6.69058913510512146331e-13, 6.82759027337033863603e-01, -6.09758759397050956538e-13, -5.06734888799676319593e-01, -1.72647929341724027123e-12, 7.31770786395845140859e-01, -2.54890507621066998113e-12, -1.26486934812332418865e+00, 3.52602080345586286818e-12, 1.30560550292085975066e+00, 3.11406502805359805172e-12, -9.73798776669942189876e-01, 6.83546587330666979906e-12, 6.36127140000814605969e-01, 9.12028065490023931567e-12, -8.53195752576814014922e-01, -7.90002444691366942016e-13, 8.16503017326735136550e-01, 5.40201398457460891938e-13, -9.65990598296217806151e-01, -5.29858649829327551828e-12, 7.57371019856180494045e-01, -7.70545190814565132280e-12, -6.38046501373884522579e-01, -1.33482118776509688649e-11, 1.42776832263500463860e-01, -1.52260332009606310661e-11, -8.76154865946936478593e-02, -1.38894046044023880997e-11, 2.64574162811193926148e-02, -1.23170893342428967675e-11, -1.25002501836241012440e-02, 1.58656698778987051317e-12, 7.08463739051921437100e-04, 3.66110838215169231106e-12, -2.66819698069129202043e-04, -6.29108934355251691938e-12, 4.76409483434920918315e-05, -9.48296746983054494823e-12, -1.47066245726930920417e-05, 2.16916235288447524835e-11, 1.07215911273860785447e-06, 3.08869211073723757016e-11, -2.76968309496473093784e-07, 3.67078855106487282313e-11, 3.34677770237885934576e-08, 3.01793379300427233740e-11, -6.77248418336000038367e-09};
	double d[]={9.15790575476520263276e-02, 1.40883036787018677570e-15, -9.12759680909582149511e-01, -3.05306027354967755392e-15, 6.83392580246825587231e-01, 4.32280192238552129780e-15, 5.75775246994565392811e-01, 3.33660049037285957743e-16, 1.87114138152933595638e-01, 5.14180089898447656492e-16, -5.04297367752770009375e-01, -7.89417022832524849787e-16, 2.89005559335286932310e-01, -4.38275307456815536464e-15, 6.94196477630007802162e-01, 1.66918737545436247521e-15, -2.42851623141933370409e-01, 1.05790349259208082972e-15, -2.30916607014755159710e+00, -4.77781887897471018969e-16, 1.15407689315779204975e+00, 4.54727630717087961775e-15, 1.06065310745522922709e+00, -4.78016593115800094322e-15, 1.50515606938283724725e-01, 1.45482151808172729587e-15, -2.41746339029848744673e+00, -4.82516160849343522101e-15, -2.43751736620331138639e+00, 4.07875210961933741614e-16, 5.15307624783564399706e+00, 2.40263073551806154252e-15, 9.86801315005328832930e-02, -1.99296318947869563116e-16, -3.45468155847174718254e-01, -2.03739271879164225472e-15, 7.29151120281588682737e-01, 1.56885687127663548239e-15, -7.95774692328607757830e-01, 5.45254842395301839211e-15, 2.36142830438578449348e-01, -8.16268089727772481172e-16, -1.67259514395226599470e-01, -5.02254422169205594845e-16, 5.86275712435866680483e-02, -2.51644439037950512774e-15, -3.06752689318121954387e-02, -2.33965241483753766981e-15, 1.92769568901153434508e-03, -6.37385778615363985332e-16, -7.85836429277702187141e-04, -2.80501370930794684271e-15, 1.51779999731296931075e-04, 2.31504915091526538768e-15, -5.00091774570324824238e-05, 9.27157244887281130073e-15, 3.88790481241355257200e-06, 1.24578537059146219035e-15, -1.06145770264850240595e-06, -4.80846712076170707205e-15, 1.36691714027951728788e-07, -2.76388370551311652918e-15, -3.22397966102145101235e-08, -8.45980661023999951214e-17};
	uint64_t ct1_hat[2][L-6][N];
	uint64_t ct2_hat[2][L-6][N];
	eval_poly_deg64<N,L,DNUM,K>(q,p,c,Delta,ct_hat,evk_hat,ct1_hat);
	eval_poly_deg64<N,L,DNUM,K>(q,p,d,Delta,ct_hat,evk_hat,ct2_hat);
	mul_rs<N,L-6,DNUM,K>(q,p,evk_hat,ct1_hat,ct2_hat,ct_evalmod_hat);
}